rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions for validation
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    
    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'admin';
    }
    
    function isValidTimestamp(timestamp) {
      return timestamp is timestamp && 
             timestamp > timestamp.date(2024, 1, 1) && 
             timestamp < timestamp.date(2030, 12, 31);
    }
    
    function hasValidSize(text, maxSize) {
      return text is string && text.size() <= maxSize;
    }
    
    function isValidUserData() {
      let data = request.resource.data;
      return data.keys().hasAll(['uid', 'email', 'name', 'role', 'qrId', 'createdAt', 'updatedAt', 'isActive']) &&
             data.uid is string &&
             data.uid.size() > 0 &&
             data.email is string &&
             data.email.matches('.*@.*\\..*') &&
             data.name is string &&
             data.name.size() > 0 &&
             data.role in ['patient', 'doctor', 'pharmacy', 'chw'] &&
             data.qrId is string &&
             data.qrId.size() > 0 &&
             data.createdAt is timestamp &&
             data.updatedAt is timestamp &&
             data.isActive is bool &&
             // Optional fields validation
             (!data.keys().hasAny(['age']) || (data.age is number && data.age >= 0 && data.age <= 150)) &&
             (!data.keys().hasAny(['photoURL']) || (data.photoURL is string && data.photoURL.size() <= 500)) &&
             (!data.keys().hasAny(['phoneNumber']) || (data.phoneNumber is string && data.phoneNumber.size() <= 20)) &&
             (!data.keys().hasAny(['lastLoginAt']) || data.lastLoginAt is timestamp);
    }
    
    function isValidUserUpdate() {
      let data = request.resource.data;
      let existingData = resource.data;
      // Prevent changing critical fields
      return data.uid == existingData.uid &&
             data.email == existingData.email &&
             data.createdAt == existingData.createdAt &&
             data.qrId == existingData.qrId &&
             // Allow updating other fields with validation
             isValidUserData();
    }
    
    // Users collection - users can only read/write their own profile
    match /users/{userId} {
      allow read: if isAuthenticated() && isOwner(userId);
      
      allow create: if isAuthenticated() && 
                   isOwner(userId) && 
                   isValidUserData() &&
                   request.resource.data.uid == request.auth.uid &&
                   request.resource.data.email == request.auth.token.email;
      
      allow update: if isAuthenticated() && 
                   isOwner(userId) && 
                   isValidUserUpdate();
      
      allow delete: if isAuthenticated() && isOwner(userId);
    }
    
    // Patients collection - doctors can read all patients, patients can read their own data
    match /patients/{patientId} {
      allow read: if isAuthenticated() && 
                 (isOwner(patientId) || getUserRole() in ['doctor', 'chw']);
      
      allow create: if isAuthenticated() && 
                   (isOwner(patientId) || getUserRole() in ['doctor', 'chw']);
      
      allow update: if isAuthenticated() && 
                   (isOwner(patientId) || getUserRole() in ['doctor', 'chw']);
      
      allow delete: if isAuthenticated() && getUserRole() == 'doctor';
    }

    // Appointments - patients and doctors can access their appointments
    match /appointments/{appointmentId} {
      allow read: if isAuthenticated() && 
                 (isOwner(resource.data.patientId) || 
                  isOwner(resource.data.doctorId));
      
      allow create: if isAuthenticated() && 
                   (getUserRole() in ['patient', 'doctor', 'chw']) &&
                   (isOwner(request.resource.data.patientId) || 
                    isOwner(request.resource.data.doctorId));
      
      allow update: if isAuthenticated() && 
                   (isOwner(resource.data.patientId) || 
                    isOwner(resource.data.doctorId)) &&
                   // Prevent changing patient/doctor IDs
                   request.resource.data.patientId == resource.data.patientId &&
                   request.resource.data.doctorId == resource.data.doctorId;
      
      allow delete: if isAuthenticated() && 
                   (isOwner(resource.data.patientId) || 
                    isOwner(resource.data.doctorId));
    }
    
    // Prescriptions - patients and doctors can access
    match /prescriptions/{prescriptionId} {
      allow read: if isAuthenticated() && 
                 (isOwner(resource.data.patientId) || 
                  isOwner(resource.data.doctorId));
      
      allow create: if isAuthenticated() && 
                   getUserRole() in ['doctor', 'chw'] &&
                   isOwner(request.resource.data.doctorId);
      
      allow update: if isAuthenticated() && 
                   isOwner(resource.data.doctorId) &&
                   // Prevent changing patient/doctor IDs
                   request.resource.data.patientId == resource.data.patientId &&
                   request.resource.data.doctorId == resource.data.doctorId;
      
      allow delete: if isAuthenticated() && 
                   isOwner(resource.data.doctorId);
    }
    
    // Pharmacies - public read, only pharmacy users can write
    match /pharmacies/{pharmacyId} {
      allow read: if isAuthenticated();
      
      allow create, update, delete: if isAuthenticated() && 
                                   getUserRole() == 'pharmacy' &&
                                   isOwner(request.resource.data.owner_id);
    }
    
    // Pharmacy inventory - only pharmacy users can access their inventory
    match /pharmacy_inventory/{inventoryId} {
      allow read, write: if isAuthenticated() && 
                        getUserRole() == 'pharmacy' &&
                        isOwner(resource.data.pharmacy_owner_id);
    }
    
    // CHW cases - only CHWs can access their cases
    match /chw_cases/{caseId} {
      allow read, write: if isAuthenticated() && 
                        getUserRole() == 'chw' &&
                        isOwner(resource.data.chw_id);
    }
    
    // Consultations - patients and doctors can access
    match /consultations/{consultationId} {
      allow read: if isAuthenticated() && 
                 (isOwner(resource.data.patientId) || 
                  isOwner(resource.data.doctorId));
      
      allow create: if isAuthenticated() && 
                   getUserRole() in ['doctor', 'patient'] &&
                   (isOwner(request.resource.data.patientId) || 
                    isOwner(request.resource.data.doctorId));
      
      allow update: if isAuthenticated() && 
                   (isOwner(resource.data.patientId) || 
                    isOwner(resource.data.doctorId));
      
      allow delete: if isAuthenticated() && 
                   isOwner(resource.data.doctorId);
    }
    
    // Medication orders - patients, doctors, and pharmacies can access
    match /medication_orders/{orderId} {
      allow read: if isAuthenticated() && 
                 (isOwner(resource.data.patient_id) || 
                  isOwner(resource.data.doctor_id) ||
                  (getUserRole() == 'pharmacy' && isOwner(resource.data.pharmacy_id)));
      
      allow create: if isAuthenticated() && 
                   getUserRole() in ['doctor', 'patient'] &&
                   (isOwner(request.resource.data.patient_id) || 
                    isOwner(request.resource.data.doctor_id));
      
      allow update: if isAuthenticated() && 
                   (isOwner(resource.data.patient_id) || 
                    isOwner(resource.data.doctor_id) ||
                    (getUserRole() == 'pharmacy' && isOwner(resource.data.pharmacy_id)));
    }
    
    // Health records - patients and their doctors can access
    match /health_records/{recordId} {
      allow read: if isAuthenticated() && 
                 (isOwner(resource.data.patient_id) || 
                  getUserRole() in ['doctor', 'chw']);
      
      allow create, update: if isAuthenticated() && 
                           getUserRole() in ['doctor', 'chw'] &&
                           // Ensure patient_id is set and valid
                           request.resource.data.keys().hasAll(['patient_id']) &&
                           request.resource.data.patient_id is string;
      
      allow delete: if isAuthenticated() && 
                   getUserRole() == 'doctor';
    }
    
    // System settings - public settings can be read by all authenticated users
    match /system_settings/{settingId} {
      allow read: if isAuthenticated() && 
                 resource.data.is_public == true;
      // Write operations handled server-side only
    }
    
    // Pharmacy stock - only pharmacy users can access their inventory
    match /pharmacy-stock/{stockId} {
      allow read, write: if isAuthenticated() && 
                        getUserRole() == 'pharmacy' &&
                        isOwner(resource.data.pharmacyId);
    }
    
    // Prescription queue - pharmacies can access their queue
    match /prescription-queue/{queueId} {
      allow read, write: if isAuthenticated() && 
                        getUserRole() == 'pharmacy' &&
                        isOwner(resource.data.pharmacyId);
    }
    
    // CHW logs - only CHWs can access their logs
    match /chw-logs/{logId} {
      allow read, write: if isAuthenticated() && 
                        getUserRole() == 'chw' &&
                        isOwner(resource.data.chwId);
    }
    
    // Emergency logs - CHWs and doctors can access
    match /emergency-logs/{logId} {
      allow read: if isAuthenticated() && 
                 getUserRole() in ['chw', 'doctor'];
      
      allow create, update: if isAuthenticated() && 
                           getUserRole() == 'chw' &&
                           isOwner(request.resource.data.chwId);
      
      allow delete: if isAuthenticated() && 
                   getUserRole() == 'doctor';
    }
    
    // Symptom rules - public read for authenticated users, admin write
    match /symptom-rules/{ruleId} {
      allow read: if isAuthenticated();
      // Write operations handled server-side only
    }
    
    // Symptom results - patients can access their results, doctors can read all
    match /symptom-results/{resultId} {
      allow read: if isAuthenticated() && 
                 (isOwner(resource.data.patientId) || 
                  getUserRole() in ['doctor', 'chw']);
      
      allow create: if isAuthenticated() && 
                   isOwner(request.resource.data.patientId) &&
                   request.resource.data.keys().hasAll(['patientId', 'selectedSymptoms', 'urgency', 'timestamp']) &&
                   request.resource.data.patientId is string &&
                   request.resource.data.selectedSymptoms is list &&
                   request.resource.data.urgency in ['low', 'medium', 'high', 'emergency'] &&
                   request.resource.data.timestamp is timestamp;
      
      allow update: if isAuthenticated() && 
                   (isOwner(resource.data.patientId) || 
                    getUserRole() in ['doctor', 'chw']) &&
                   // Prevent changing core fields
                   request.resource.data.patientId == resource.data.patientId &&
                   request.resource.data.selectedSymptoms == resource.data.selectedSymptoms &&
                   request.resource.data.timestamp == resource.data.timestamp;
      
      allow delete: if isAuthenticated() && 
                   getUserRole() == 'doctor';
    }
    
    // Symptom categories - public read for authenticated users
    match /symptom-categories/{categoryId} {
      allow read: if isAuthenticated();
      // Write operations handled server-side only
    }
    
    // QR health records - patients own their records, healthcare providers can access
    match /qr-health-records/{recordId} {
      allow read: if isAuthenticated() && 
                 (isOwner(resource.data.patientId) || 
                  getUserRole() in ['doctor', 'chw', 'pharmacy']);
      
      allow create: if isAuthenticated() && 
                   (isOwner(request.resource.data.patientId) || 
                    getUserRole() in ['doctor', 'chw']);
      
      allow update: if isAuthenticated() && 
                   (isOwner(resource.data.patientId) || 
                    getUserRole() in ['doctor', 'chw']);
      
      allow delete: if isAuthenticated() && 
                   getUserRole() == 'doctor';
    }
    
    // QR scan logs - users can read their own scan logs, admins can read all
    match /qr-scan-logs/{logId} {
      allow read: if isAuthenticated() && 
                 (isOwner(resource.data.scannedBy) || 
                  isOwner(resource.data.patientId) ||
                  getUserRole() == 'doctor');
      
      allow create: if isAuthenticated() && 
                   isOwner(request.resource.data.scannedBy);
      
      // No update/delete - logs are immutable
    }
    
    // Notification configs - users can manage their own notification settings
    match /notification-configs/{configId} {
      allow read, write: if isAuthenticated() && 
                        isOwner(resource.data.userId);
    }
    
    // Notifications - users can read their own notifications
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && 
                 isOwner(resource.data.userId);
      
      allow update: if isAuthenticated() && 
                   isOwner(resource.data.userId) &&
                   // Only allow updating read status
                   request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isRead', 'updatedAt']);
      
      // Create/delete operations handled server-side only
    }
    
    // Audit log - read-only for authenticated users (their own actions)
    match /audit_log/{logId} {
      allow read: if isAuthenticated() && 
                 isOwner(resource.data.user_id);
      // Write operations handled server-side only
    }
    
    // Analytics collections - admin-only access
    match /daily-metrics/{metricId} {
      allow read: if isAdmin();
      // Write operations handled server-side only
    }
    
    match /doctor-analytics/{analyticsId} {
      allow read: if isAdmin();
      // Write operations handled server-side only
    }
    
    match /pharmacy-analytics/{analyticsId} {
      allow read: if isAdmin();
      // Write operations handled server-side only
    }
  }
}